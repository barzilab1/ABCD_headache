---
title: "Main analysis"
author: "Kate Tran"
date: "7/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(purrr)
library(sjPlot)
# library(parameters)
library(stringr)
library(performance)
library(janitor)

source("../utility_fun.R")
```

```{r}
data_long <- read.csv("../outputs/dataset_long.csv")

matched_data <- read.table(file = '../data/participants.tsv', header = TRUE)
matched_data <- matched_data %>% 
    mutate(participant_id = str_replace_all(participant_id, "sub-", ""),
           participant_id = str_replace_all(participant_id, "NDAR", "NDAR_"))
```

```{r}
## Create 2 different datasets, run univariate models on the first half

# Get IDs of participants in group 1
id_gr1 <- matched_data %>% filter(matched_group == 1) %>% select(participant_id) %>% pull()
id_gr2 <- matched_data %>% filter(matched_group == 2) %>% select(participant_id) %>% pull()

# Create ABCD dataset 1 & 2
abcd_gr1 <- data_long %>% filter(src_subject_id %in% id_gr1)
abcd_gr2 <- data_long %>% filter(src_subject_id %in% id_gr2)

# Write data for sensitivity analysis
saveRDS(abcd_gr1, file = "../outputs/abcd_gr1.rds")
saveRDS(abcd_gr2, file = "../outputs/abcd_gr2.rds")
```

```{r}
# Run univariate models on the first half of the data: abcd_gr1
vars <- data_long %>% 
    dplyr::select(matches(c("d_inc|famhx_ss_mom|dim_y|harm(2?)$|bully|hood(_?)[^_P]|nsc_|adi.*_[irmp]|pmq|fes_y.*_fc$|crpbi|srpf|macv_y.*fs|ple.*[^fu]_(y|fu_y_bad)$|hx.*[26][ij]|tbi.*_l$|tbi_[123457]|cat$"))) %>% names()
```

```{r}
# Run univariate on the 1st dataset only
var_headache_0 <- "(1 | site_id_l_br/rel_family_id/src_subject_id)"

output <- data.frame("variable" = NA, "Odds ratio" = NA, "p_value" = NA, "std.error" = NA, "low_ci" = NA, "high_ci" = NA)

# Significant (p-value <= 0.05)
univariate_headache_1toall <- vars[1:length(vars)] %>%  
    map_dfr(~get_est(outcome = "medhx_2q_l", predictor = .x, variables = var_headache_0, data = abcd_gr1, estimate = "OR", output = output, conf_int = 0.95))

univariate_headache_1toall <- univariate_headache_1toall %>% 
    mutate(significant = case_when(p_value <= 0.05 ~ "sig", TRUE ~ NA_character_))

writexl::write_xlsx(univariate_headache_1toall, "../outputs/univariate_headache_1toall_120822_abcd.xlsx")
```

```{r}
# Choose significant elements
sig_vars <- univariate_headache_1toall %>% filter(significant == "sig") %>% select(variable) %>% pull()

# Forest plot
output_plot <- data.frame("variable" = NA, "coef" = NA, "p_value" = NA, "std.error" = NA, "low_ci" = NA, "high_ci" = NA)
univariate_plot <- sig_vars %>%
    map_dfr(~get_est(outcome = "medhx_2q_l", predictor = .x, variables = var_headache_0, data = abcd_gr1, estimate = "coef", output = output_plot, conf_int = 0.95))
saveRDS(univariate_plot, file = "../outputs/univariate_plot_abcdgr1_coef_120922.rds")
```

```{r}
# Get weight from abcd_gr1 # but use binary variables only
# Replace continuous variables in sig_vars by binary variables

# Run the logistic regression of significant variables on the second half of the data
output_testing <- data.frame("variable" = NA, "coef" = NA, "p_value" = NA, "std.error" = NA, "low_ci" = NA, "high_ci" = NA)

sig_vars_bin <- sig_vars
# Dichotomize 1 Likert variable
sig_vars_bin[sig_vars_bin == "tbi_ss_worst_overall_l"] <- "tbi_worst_overall"
sig_vars_bin[sig_vars_bin == "tbi_ss_worst_overall_l"] <- NULL

# Get coefficients (weight) for all variables including new dichotomized variables
univariate_testing <- sig_vars_bin %>%  
    map_dfr(~get_est(outcome = "medhx_2q_l", predictor = .x, variables = var_headache_0, data = abcd_gr1, estimate = "coef", output = output_testing, conf_int = 0.95))

weight <- univariate_testing %>% arrange(coef) %>% select(coef) %>% pull()
# Make sure columns in abcd_gr2 same order as in weight
abcd_gr2_weight <- transform(abcd_gr2, weighted_exposome = 
                                   rowSums(
                                       sweep(abcd_gr2 %>% select(all_of(univariate_testing %>% arrange(coef) %>% select(variable) %>% pull())), 2, weight, `*`), 
                                       na.rm = T))
```

```{r}
# Table 3
mod1 <- glmer(medhx_2q_l ~ (1 | site_id_l_br/rel_family_id/src_subject_id) + 
                   age_years + age_years^2 + age_years^3 + sex_br + household_income, 
              nAGQ = 0, family = binomial, data = abcd_gr2_weight %>% filter(genetic_afr == 0)) # EUR ancestry

mod2 <- glmer(medhx_2q_l ~ scale(weighted_exposome) + (1 | site_id_l_br/rel_family_id/src_subject_id) + 
                   age_years + age_years^2 + age_years^3 + sex_br + household_income, 
              nAGQ = 0, family = binomial, data = abcd_gr2_weight %>% filter(genetic_afr == 0)) # EUR ancestry

mod3 <- glmer(medhx_2q_l ~ migraine_PRS_EUR + (1 | site_id_l_br/rel_family_id/src_subject_id) + 
                   age_years + age_years^2 + age_years^3 + sex_br + household_income, 
              nAGQ = 0, family = binomial, data = abcd_gr2_weight %>% filter(genetic_afr == 0))

mod4 <- glmer(medhx_2q_l ~ scale(weighted_exposome) + migraine_PRS_EUR + (1 | site_id_l_br/rel_family_id/src_subject_id) + 
                   age_years + age_years^2 + age_years^3 + sex_br + household_income, 
              nAGQ = 0, family = binomial, data = abcd_gr2_weight %>% filter(genetic_afr == 0))

mod5 <- glmer(medhx_2q_l ~ scale(weighted_exposome) * migraine_PRS_EUR + (1 | site_id_l_br/rel_family_id/src_subject_id) + 
                   age_years + age_years^2 + age_years^3 + sex_br + household_income, nAGQ = 0, family = binomial, 
               data = abcd_gr2_weight %>% filter(genetic_afr == 0))

com1 <- tab_model(mod1, mod2, mod3, mod4, mod5)

# Nagelkerkeâ€™s R2
r2(mod1)[2]
r2(mod2)[2]
r2(mod3)[2]
r2(mod4)[2]
r2(mod5)[2]

anova(mod1, mod2, test="Chisq")
anova(mod1, mod3, test="Chisq")
anova(mod2, mod4, test="Chisq")
anova(mod3, mod4, test="Chisq") 
anova(mod4, mod5, test="Chisq") 

# adj p
round(p.adjust(c(5.041e-10, 0.0005374, 0.0009378, 8.566e-10, 0.1062), method = "fdr"), 3)
```

# Supplement - models on whole cohort
```{r}
# eTable 5
mod21 <- glmer(medhx_2q_l ~ (1 | site_id_l_br/rel_family_id/src_subject_id) + age_years + age_years^2 + age_years^3 + sex_br + household_income, 
              nAGQ = 0, family = binomial, data = abcd_gr2_weight) # all population

mod22 <- glmer(medhx_2q_l ~ weighted_exposome + (1 | site_id_l_br/rel_family_id/src_subject_id) + age_years + age_years^2 + age_years^3 + sex_br + household_income, 
              nAGQ = 0, family = binomial, data = abcd_gr2_weight) # all population

com2 <- tab_model(mod21, mod22)

r2(mod21)[2]
r2(mod22)[2]

anova(mod21, mod22, test="Chisq")
```












