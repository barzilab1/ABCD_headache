---
title: "Main analysis"
author: "Kate Tran"
date: "7/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Library
```{r}
library(sjPlot) # if doesn't work, run devtools::install_github("strengejacke/sjPlot")
library(stringr)
library(performance)
library(janitor)
library(dplyr)
library(purrr)
source("../utility_fun.R")
source("../config.R")
```

# Read data
```{r}
# data_long <- read.csv("../data/dataset_long.csv")

# matched_data <- read.table(file = file.path(abcd_partition_path, "participants.tsv"), header = TRUE)
# matched_data <- matched_data %>% 
#     mutate(participant_id = str_replace_all(participant_id, "sub-", ""),
#            participant_id = str_replace_all(participant_id, "NDAR", "NDAR_"))
```

# Create discovery and testing subsets
```{r}
# # Get IDs of participants in group 1
# id_gr1 <- matched_data %>% filter(matched_group == 1) %>% pull(participant_id)
# id_gr2 <- matched_data %>% filter(matched_group == 2) %>% pull(participant_id)
# 
# # Create ABCD dataset 1 & 2
# abcd_gr1 <- data_long %>% filter(src_subject_id %in% id_gr1)
# abcd_gr2 <- data_long %>% filter(src_subject_id %in% id_gr2)

# Write data for sensitivity analysis
# saveRDS(abcd_gr1, file = "../outputs/abcd_gr1.rds")
# saveRDS(abcd_gr2, file = "../outputs/abcd_gr2.rds")

abcd_gr1 <- readRDS("outputs/abcd_gr1.rds")
abcd_gr2 <- readRDS("outputs/abcd_gr2.rds")
```

# Univariate models on abcd_gr1
```{r}
# Run univariate models on the first half of the data: abcd_gr1
vars <- data_long %>% 
    dplyr::select(matches(c("d_inc|famhx_ss_mom|dim_y|harm(2?)$|bully|hood(_?)[^_P]|nsc_|adi.*_[irmp]|pmq|fes_y.*_fc$|crpbi|srpf|macv_y.*fs|ple.*[^fu]_(y|fu_y_bad)$|hx.*[26][ij]|tbi.*_l$|tbi_[123457]|cat$|alcohol$|tobacco$"))) %>% names() # 98 vars

saveRDS(vars, "../outputs/vars_98.rds")
```

# Create data for forest plot

```{r}
# Exwas 1 on original variables - get significant variables - Not FDR corrected p-values for headache project - No covariates
exwas_headache <- exwas(data_train = abcd_gr1, vars = vars, outcome = "medhx_2q_l", data_test = abcd_gr2)
univariate_headache <- exwas_headache$univariate_models_dat

# eTable4
univariate_headache_sig <- exwas_headache$univariate_models_sig %>% 
    mutate(low_ci = round(exp(low_ci), 2), high_ci = round(exp(high_ci), 2), 
           CI_95 = paste0(low_ci, " - ", high_ci), p_value = round(p_value, 3)) %>% 
    select(variable, OR, CI_95, p_value)
write.csv(univariate_headache_sig, "../outputs/univariate_headache_sig_061323.csv")

sig_vars <- univariate_headache_sig %>% pull(variable)

saveRDS(univariate_headache, file = "../outputs/univariate_plot_abcdgr1_coef_051523.rds") #univariate_plot_abcdgr1_coef_120922.rds
```

# Generate exposome score
```{r}
# Get weight from abcd_gr1 # but use binary variables of Likert variables only
# Exwas 2 on updated variables (with binary variables) - get coefficients
sig_vars_bin <- sig_vars
# Dichotomize 2 Likert variables
sig_vars_bin[sig_vars_bin == "tbi_ss_worst_overall_l"] <- "tbi_worst_overall"
sig_vars_bin[sig_vars_bin == "neighborhood3r_p"] <- "neighborh_notsafe"
# sig_vars_bin[sig_vars_bin == "tbi_ss_worst_overall_l"] <- NULL
# sig_vars_bin[sig_vars_bin == "neighborhood3r_p"] <- NULL

exwas_headache_binary <- exwas(data_train = abcd_gr1, vars = sig_vars_bin, outcome = "medhx_2q_l", data_test = abcd_gr2)
abcd_gr2_weight <- exwas_headache_binary$data_test_exposome
```

# Multivariate models in the main result
```{r}
# Table 3
mod1 <- glmer(medhx_2q_l ~ (1 | site_id_l_br/rel_family_id/src_subject_id) + 
                   age_years + age_years^2 + age_years^3 + sex_br + race_black + ethnicity_hisp,
              nAGQ = 0, family = binomial, data = abcd_gr2_weight %>% filter(genetic_afr == 0))

mod2 <- glmer(medhx_2q_l ~ scale(weighted_exposome) + (1 | site_id_l_br/rel_family_id/src_subject_id) + 
                   age_years + age_years^2 + age_years^3 + sex_br + race_black + ethnicity_hisp, 
              nAGQ = 0, family = binomial, data = abcd_gr2_weight %>% filter(genetic_afr == 0))

mod3 <- glmer(medhx_2q_l ~ migraine_PRS_EUR + (1 | site_id_l_br/rel_family_id/src_subject_id) + 
                   age_years + age_years^2 + age_years^3 + sex_br + race_black + ethnicity_hisp, 
              nAGQ = 0, family = binomial, data = abcd_gr2_weight %>% filter(genetic_afr == 0))

mod4 <- glmer(medhx_2q_l ~ scale(weighted_exposome) + migraine_PRS_EUR + (1 | site_id_l_br/rel_family_id/src_subject_id) + 
                   age_years + age_years^2 + age_years^3 + sex_br + race_black + ethnicity_hisp, 
              nAGQ = 0, family = binomial, data = abcd_gr2_weight %>% filter(genetic_afr == 0))

mod5 <- glmer(medhx_2q_l ~ scale(weighted_exposome) * migraine_PRS_EUR + (1 | site_id_l_br/rel_family_id/src_subject_id) + 
                   age_years + age_years^2 + age_years^3 + sex_br + race_black + ethnicity_hisp, 
              nAGQ = 0, family = binomial, data = abcd_gr2_weight %>% filter(genetic_afr == 0))

com1 <- tab_model(mod1, mod2, mod3, mod4, mod5)

# Nagelkerkeâ€™s R2
r2(mod1)[2]
r2(mod2)[2]
r2(mod3)[2]
r2(mod4)[2]
r2(mod5)[2]

anova(mod1, mod2, test="Chisq")
anova(mod1, mod3, test="Chisq")
anova(mod2, mod3, test="Chisq")
anova(mod2, mod4, test="Chisq")
anova(mod3, mod4, test="Chisq") 
anova(mod4, mod5, test="Chisq") 

# adj p
round(p.adjust(c(1.939e-11, 0.0007253, 0, 0.00119, 3.098e-11, 0.08736), method = "fdr"), 3)
```

# Supplement - models on whole cohort
```{r}
# eTable 5
mod21 <- glmer(medhx_2q_l ~ (1 | site_id_l_br/rel_family_id/src_subject_id) + age_years + age_years^2 + age_years^3 + 
                   sex_br + race_black + race_white + ethnicity_hisp,
              nAGQ = 0, family = binomial, data = abcd_gr2_weight) # all population

mod22 <- glmer(medhx_2q_l ~ weighted_exposome + (1 | site_id_l_br/rel_family_id/src_subject_id) + age_years + age_years^2 + age_years^3 + 
                   sex_br + race_black + race_white + ethnicity_hisp, 
              nAGQ = 0, family = binomial, data = abcd_gr2_weight) # all population

com2 <- tab_model(mod21, mod22)

r2(mod21)[2]
r2(mod22)[2]

anova(mod21, mod22, test="Chisq")
```












