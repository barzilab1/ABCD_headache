---
title: "Untitled"
author: "Kate Tran"
date: "7/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(tableone)
library(purrr)
library(sjPlot)
library(parameters)
library(stringr)
library(MatchIt)
library(sjPlot)
library(performance)
library(janitor)

source("../utility_fun.R")
```

```{r}
data_wide <- read.csv("../outputs/dataset_wide.csv")
data_long <- read.csv("../outputs/dataset_long.csv")
```

```{r}
# table 1: by headache ever
table1_var <- data_wide %>% 
    select(matches(c("age_years__2y", "sex_br", "race", "ethnicity", "poverty_line$", "edu$"))) %>% names()

table1_factor <- table1_var[!table1_var %in% c("age_years__2y", "parents_avg_edu")]


write.csv(print(
  CreateTableOne(
    data = data_wide,
    vars = table1_var,
    strata = "headache_ever",
    factorVars = table1_factor,
    includeNA = T,
    addOverall = T
  ),
    missing = T,
  pDigits = 5
),
"../outputs/table1_main_values_101922.csv")


# FDR-adjusted p-values
table1_adj_p = round(p.adjust(c(0.00293, 0.66945, 0.00001, 0.00001, 0.00002, 0.81631, 0.64358, 0.09838, 0.00009, 0.00789, 0.00001), method = "fdr"), 3)


# create migraine PRS among Euro ancestry (white)
# don't have PRS among African ancestry

# table 2: internal validation # by headache
table2_var <- c("daily_med_2w_ever", "rescue_med_2w_ever") #, "migraine_PRS_EUR"
# table2_factor <- table2_var[!table2_var %in% "migraine_PRS_EUR"]

write.csv(print(
  CreateTableOne(
    data = data_wide,
    vars = table2_var,
    strata = "headache_ever",
    factorVars = table2_var,
    includeNA = T,
    addOverall = T
  ),
    missing = T,
  pDigits = 5
),
"../outputs/table2_main_values_101922.csv")

table2_adj_p <- round(p.adjust(c(0.00001, 0.00001), method = "fdr"), 3)
```

```{r}
# table 2: verification headache and medication/PRS
mod_headache_med1 <- glmer(data = data_long, 
                           medhx_2q_l~Migraine.Medications_2w + scale(age_years) + scale(age_years)^2 + scale(age_years)^3 + sex_br + race_black + race_white + ethnicity_hisp + household_income +
                               (1 | site_id_l_br/rel_family_id/src_subject_id), family = binomial, nAGQ = 0)

mod_headache_med2 <- glmer(data = data_long, 
                           medhx_2q_l~Daily.Preventive.medications_2w + scale(age_years) + scale(age_years)^2 + scale(age_years)^3  + sex_br + race_black + race_white + ethnicity_hisp + household_income +
                               (1 | site_id_l_br/rel_family_id/src_subject_id), family = binomial, nAGQ = 0)

mod_headache_med3 <- glmer(data = data_long, 
                           medhx_2q_l~Rescue.Medications_2w + scale(age_years) + scale(age_years)^2 + scale(age_years)^3  + sex_br + race_black + race_white + ethnicity_hisp + household_income +
                               (1 | site_id_l_br/rel_family_id/src_subject_id), family = binomial, nAGQ = 0)

mod_headache_prs <- glmer(data = data_long, 
                           medhx_2q_l~migraine_PRS_EUR + scale(age_years) + scale(age_years)^2 + scale(age_years)^3  + sex_br + race_black + race_white + ethnicity_hisp + household_income +
                               (1 | site_id_l_br/rel_family_id/src_subject_id), family = binomial, nAGQ = 0)

tab_model(mod_headache_med1, mod_headache_med2, mod_headache_med3, mod_headache_prs, show.intercept = F)
```












